{% extends "base.html" %}

{% block title %}Module 3 Project{% endblock %}

{% block content %}
<div class="module3-page">
<section class="module3-hero">
    <div class="module3-hero-text">
        <h1>Module 3 Project – PostgreSQL Queries</h1>
        <p>Key applicant insights from the 2026 cycle, summarized from the database.</p>
    </div>
    <div class="module3-hero-actions">
        <div class="module3-hero-badge">PostgreSQL</div>
        <div class="hero-action-stack">
            <form action="{{ url_for('m3_pages.update_analysis') }}" method="post">
                <button class="action-button" type="submit" {% if pull_running %}disabled{% endif %}>
                    Update Analysis
                </button>
            </form>
            <span class="action-help">
                Refreshes the stats below with the newest data.
                {% if pull_running %}Disabled while Pull Data is running.{% endif %}
            </span>
        </div>
    </div>
</section>

<section class="module3-actions">
    <div class="action-card">
        <div>
            <h2>LLM Status</h2>
            {% if llm_ready %}
            <p class="action-note">LLM server is ready. Pull Data will clean records before inserting them.</p>
            {% else %}
            <p class="action-note">LLM server is not ready yet. Start it and refresh this page.</p>
            <p class="action-note">From `Module_3/llm_hosting`: run <code>python app.py --serve</code>.</p>
            {% endif %}
        </div>
    </div>
    <div class="action-card pull-card">
        <div class="pull-body">
            <h2>Pull New Data</h2>
            <p>Fetches the latest GradCafe entries using the Module 2 scraper, cleans them with the LLM, and inserts any new records into the database.</p>
            <p class="action-note">This pull targets up to {{ max_new_records }} new records (or stops at the latest GradCafe submission if fewer remain).</p>
            {% if not llm_ready %}
            <p class="action-note">LLM server is warming up. Pull Data will be enabled once it is ready.</p>
            {% elif pull_running %}
            <p class="action-note">A pull is currently running. This button will be re-enabled when it finishes.</p>
            {% else %}
            <p class="action-note">When the pull finishes (or reaches the max new records), you can run it again.</p>
            {% endif %}
        </div>
        <div class="pull-meta">
            <div class="pull-timer" id="pull-eta">
                {% if pull_running %}
                Estimating time remaining...
                {% else %}
                Ready to pull when the LLM is online.
                {% endif %}
            </div>
            <form action="{{ url_for('m3_pages.pull_data') }}" method="post">
                <button class="action-button" type="submit" {% if pull_running or not llm_ready %}disabled{% endif %}>
                    Pull Data
                </button>
            </form>
        </div>
    </div>
    <div class="action-card">
        <div>
            <h2>Analysis Report (PDF)</h2>
            <p>Download the latest answers and query descriptions. This report updates when you click Update Analysis.</p>
        </div>
        {% if pull_running %}
        <span class="action-button secondary disabled" aria-disabled="true">View PDF</span>
        {% else %}
        <a class="action-button secondary" href="{{ report_url }}" target="_blank" rel="noopener">
            View PDF
        </a>
        {% endif %}
    </div>
</section>

{% if status_message %}
<div class="status-banner">
    {{ status_message }}
</div>
{% endif %}

{% if pull_running %}
<script>
    const formatEta = (seconds) => {
        if (!seconds || seconds < 0 || !Number.isFinite(seconds)) return "Estimating time remaining...";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins <= 0) return `~${secs}s remaining`;
        return `~${mins}m ${secs}s remaining`;
    };

    const pollPullStatus = async () => {
        try {
            const res = await fetch("{{ url_for('m3_pages.pull_status') }}");
            if (!res.ok) return;
            const data = await res.json();
            const etaEl = document.getElementById("pull-eta");
            if (etaEl && data.progress) {
                const progress = data.progress || {};
                const inserted = Number(progress.inserted || 0);
                const processed = Number(progress.processed || 0);
                const target = Number(progress.target || 0);
                const elapsed = Number(progress.elapsed_seconds || 0);
                let etaSeconds = null;
                if (inserted > 0 && processed > 0) {
                    const insertsPerPage = inserted / processed;
                    const remainingInserts = Math.max(target - inserted, 0);
                    const estRemainingPages = insertsPerPage > 0 ? remainingInserts / insertsPerPage : null;
                    const pagesPerSecond = processed / Math.max(elapsed, 1);
                    etaSeconds = estRemainingPages && pagesPerSecond > 0 ? estRemainingPages / pagesPerSecond : null;
                }
                etaEl.textContent = formatEta(etaSeconds);
            }
            if (data.done && !data.running) {
                window.location = "{{ url_for('m3_pages.module_3_project') }}";
            }
        } catch (err) {
            // ignore transient errors
        }
    };
    setInterval(pollPullStatus, 5000);
</script>
{% endif %}

<section class="module3-section">
    <h2 class="section-title">Snapshot</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Applicants surveyed</div>
            <div class="stat-value">{{ results.total_applicants }}</div>
            <div class="stat-sub">Total entries in the database</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Fall 2026 entries</div>
            <div class="stat-value">{{ results.fall_2026_count }}</div>
            <div class="stat-sub">Total applications</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">International share</div>
            <div class="stat-value">{{ results.percent_international }}%</div>
            <div class="stat-sub">Across all applications</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Acceptance rate</div>
            <div class="stat-value">{{ results.acceptance_rate_fall_2026 }}%</div>
            <div class="stat-sub">Fall 2026 applicants</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">JHU MS in CS</div>
            <div class="stat-value">{{ results.jhu_masters_cs }}</div>
            <div class="stat-sub">Applicants matching program</div>
        </div>
    </div>
</section>

<section class="module3-section">
    <h2 class="section-title">Applicant Metrics</h2>
    <div class="content-card">
        <table class="metrics-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Average</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>GPA</td>
                    <td>{{ results.average_metrics.avg_gpa if results.average_metrics.avg_gpa is not none else "N/A" }}</td>
                </tr>
                <tr>
                    <td>GRE Quant</td>
                    <td>{{ results.average_metrics.avg_gre if results.average_metrics.avg_gre is not none else "N/A" }}</td>
                </tr>
                <tr>
                    <td>GRE Verbal</td>
                    <td>{{ results.average_metrics.avg_gre_v if results.average_metrics.avg_gre_v is not none else "N/A" }}</td>
                </tr>
                <tr>
                    <td>GRE Analytical Writing</td>
                    <td>{{ results.average_metrics.avg_gre_aw if results.average_metrics.avg_gre_aw is not none else "N/A" }}</td>
                </tr>
            </tbody>
        </table>
        <div class="split-grid">
            <div class="split-item">
                <div class="split-label">Avg GPA (American, Fall 2026)</div>
                <div class="split-value">{{ results.avg_gpa_american_fall_2026 if results.avg_gpa_american_fall_2026 is not none else "N/A" }}</div>
            </div>
            <div class="split-item">
                <div class="split-label">Avg GPA (Acceptances, Fall 2026)</div>
                <div class="split-value">{{ results.avg_gpa_acceptances_fall_2026 if results.avg_gpa_acceptances_fall_2026 is not none else "N/A" }}</div>
            </div>
        </div>
    </div>
</section>

<section class="module3-section">
    <h2 class="section-title">Top PhD CS Acceptances (2026)</h2>
    <p class="section-description">
        These counts include accepted applicants who applied to Georgetown University, MIT, Stanford University,
        or Carnegie Mellon University for a PhD in Computer Science.
    </p>
    <div class="compare-grid">
        <div class="stat-card">
            <div class="stat-label">Raw university names</div>
            <div class="stat-value">{{ results.top_phd_acceptances_2026_raw }}</div>
            <div class="stat-sub">University field</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">LLM-generated names</div>
            <div class="stat-value">{{ results.top_phd_acceptances_2026_llm }}</div>
            <div class="stat-sub">LLM university field</div>
        </div>
    </div>
    <p class="note">Comparing raw vs. LLM-normalized names helps capture acronyms and inconsistent university labels.</p>
</section>

<section class="module3-section">
    <h2 class="section-title">Additional Insights</h2>
    <p class="section-description">
        These optional queries explore extra patterns in the dataset, including citizenship breakdowns and GRE
        performance for PhD Computer Science applicants in Fall 2026.
    </p>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">International count (Fall 2026)</div>
            <div class="stat-value">{{ results.additional_question_1 }}</div>
            <div class="stat-sub">Non‑American, non‑“Other”</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg GRE (PhD CS, Fall 2026)</div>
            <div class="stat-value">{{ results.additional_question_2 if results.additional_question_2 is not none else "N/A" }}</div>
            <div class="stat-sub">GRE Quant average</div>
        </div>
    </div>
</section>

</div>
{% endblock %}
